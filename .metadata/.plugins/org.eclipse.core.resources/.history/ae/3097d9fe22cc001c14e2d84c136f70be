package com.lms.accesslibrary.service;

import javax.transaction.Transactional;

import org.springframework.stereotype.Service;

import com.lms.accesslibrary.bo.BookReservation;
import com.lms.accesslibrary.constant.Constants;
import com.lms.accesslibrary.dao.BookItemRepository;
import com.lms.accesslibrary.dao.UserRepository;
import com.lms.accesslibrary.dto.Checkout;
import com.lms.accesslibrary.dto.CheckoutResponse;
import com.lms.accesslibrary.entity.library.book.BookItem;
import com.lms.accesslibrary.entity.library.user.Member;
import com.lms.accesslibrary.entity.library.user.User;
import com.lms.accesslibrary.enums.ReservationStatus;

@Service
public class UserServiceImpl implements UserService {
	
	private UserRepository memberRepository;
	private BookItemRepository bookItemRepository;	
	
	
	String errCode = "";
	@Override
	public String checkoutBookItem(String userId, String bookItemBarcode) {
		
		User user = memberRepository.findByUserId(userId);
		BookItem bookItem = bookItemRepository.findByBarcode(bookItemBarcode);
		
		if (user.getTotalBooksCheckedout() >= Constants.MAX_BOOKS_ISSUED_TO_A_USER) {
			errCode= "The user has already checked-out maximum number of books";
			return errCode;
		}
		BookReservation bookReservation = BookReservation.fetchReservationDetails(bookItem.getBarcode());
		if (bookReservation != null && bookReservation.getUserId() != user.getId()) {
			// book item has a pending reservation from another user
			errCode = "This book is reserved by another member";
			return errCode;
		} else if (bookReservation != null) {
			// book item has a pending reservation from the give member, update it
			bookReservation.setStatus(ReservationStatus.COMPLETED);
		}

		if (!bookItem.checkout(user.getId())) {
			return "FAILED";
		}

		this.incrementTotalBooksCheckedout(bookItem);

		return "SUCCESS";
	}

	@Override
	public String returnBookItem(String bookItemBarcode) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public String renewBookItem(String bookItemBarcode) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public String payFine(String bookItemBarcode) {
		// TODO Auto-generated method stub
		return null;
	}
	
	private void decrementTotalBooksCheckedout(BookItem bookItem) {
		this.setTotalBooksCheckedout(this.getTotalBooksCheckedout() - 1);
	}

	@Override
	public String checkoutBookItem(String bookItemBarcode) {
		// TODO Auto-generated method stub
		return null;
	}
	

}
